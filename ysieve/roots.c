/*
MIT License

Copyright (c) 2021 Ben Buhrow

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
*/

#include <stdio.h>
#include <string.h>
#include <math.h>
#include "soe.h"
#include "ytools.h"
#include "threadpool.h"
#include "soe_impl.h"

#define USE_NEW_ROOTCALC


static __inline uint32_t redc_loc(uint64_t x, uint32_t pinv, uint32_t p)
{
    uint32_t m = (uint32_t)x * pinv;
    x += (uint64_t)m * (uint64_t)p;
    m = x >> 32;
    if (m >= p) m -= p;
    return m;
}

static __inline uint32_t to_monty_loc(uint32_t x, uint32_t r2, uint32_t pinv, uint32_t p)
{
    uint64_t t = (uint64_t)x * (uint64_t)r2;
    return redc_loc(t, pinv, p);
}


void compute_roots_dispatch(void *vptr)
{
    tpool_t *tdata = (tpool_t *)vptr;
    soe_userdata_t *t = (soe_userdata_t *)tdata->user_data;
    soe_staticdata_t *sdata = t->sdata;

    if (sdata->sync_count < sdata->THREADS)
    {
        tdata->work_fcn_id = 0;
        sdata->sync_count++;
    }
    else
    {
        tdata->work_fcn_id = tdata->num_work_fcn;        
    }

    return;
}



//printf("-c^-1 mod prodN: ");
//for (i = 0; i < sdata->numclasses; i++)
//{
//    class_inv[i] = pn - modinv_1(sdata->rclass[i], pn);
//    printf("%u, ", class_inv[i]);
//}
//printf("\n");

static uint32_t class_inv6[8] = { 5, 1 };
static uint32_t class_inv30[8] = { 29, 17, 19, 23, 7, 11, 13, 1 };
static uint32_t class_inv210[48] = {
    209, 19, 113, 37, 11,
    73, 181, 149, 17, 169,
    83, 67, 103, 121, 179,
    47, 139, 23, 101, 43,
    151, 197, 79, 53, 157,
    131, 13, 59, 167, 109,
    187, 71, 163, 31, 89,
    107, 143, 127, 41, 193,
    61, 29, 137, 199, 173,
    97, 191, 1 };
static uint32_t class_inv420[96] = { 419,229,323,247,221,73,391,149,227,379,
293,277,103,121,179,257,349,23,101,253,
151,407,79,53,157,131,223,59,377,109,
187,281,373,31,89,107,353,337,251,403,
61,239,137,409,383,307,401,211,209,19,
113,37,11,283,181,359,17,169,83,67,
313,331,389,47,139,233,311,43,361,197,
289,263,367,341,13,269,167,319,397,71,
163,241,299,317,143,127,41,193,271,29,
347,199,173,97,191,1};
static uint32_t class_inv2310[480] = {
    2309, 533, 1087, 851, 703, 2071, 149, 437,
    169, 1343, 1327, 523, 1801, 1439, 1517, 1399,
    443, 731, 2143, 571, 1667, 709, 2153, 367,
    551, 1063, 1637, 529, 607, 1961, 31, 719, 2207,
    1403, 2227, 41, 2083, 271, 1289, 1669, 383,
    727, 1451, 1259, 439, 953, 2137, 1271, 1963,
    2281, 1409, 1487, 589, 1537, 1783, 541, 179,
    467, 559, 653, 1151, 883, 1831, 617, 1129,
    893, 787, 1273, 1319, 377, 2077, 2171, 373,
    1081, 1139, 107, 353, 337, 1091, 193, 481,
    449, 1187, 409, 1433, 401, 1891, 1679, 1699,
    1163, 37, 221, 73, 391, 647, 1849, 923, 277,
    2011, 389, 887, 1609, 1073, 1361, 1093, 2251,
    1339, 53, 2047, 131, 13, 269, 587, 109, 817,
    281, 1633, 1291, 89, 1157, 547, 251, 1453,
    1531, 1499, 137, 1879, 1643, 307, 821, 841,
    1889, 2119, 2213, 457, 283, 1651, 989, 1697,
    2183, 1747, 1363, 751, 809, 1097, 1819, 23,
    101, 1513, 151, 197, 79, 1103, 1391, 1483,
    689, 1007, 1369, 1027, 1541, 2053, 1711,
    317, 2243, 1597, 1301, 691, 1709, 557, 619,
    2063, 1567, 1031, 1261, 629, 19, 1373, 1717,
    2111, 1333, 2249, 1907, 1429, 293, 487, 313,
    961, 2069, 2147, 2239, 1571, 463, 1201, 1457,
    1549, 1313, 1627, 1811, 223, 899, 2267, 1789,
    1447, 2263, 661, 1979, 1367, 1193, 757, 1511,
    1033, 1741, 2129, 767, 829, 1013, 1987, 2081,
    1471, 2099, 1069, 113, 1061, 493, 1231, 359,
    17, 379, 503, 697, 733, 1381, 1307, 1189,
    1913, 311, 361, 1877, 289, 1733, 577, 2021,
    433, 1949, 1999, 397, 1121, 1003, 929, 1577,
    1613, 1807, 1931, 2293, 1951, 1079, 1817,
    1249, 2197, 1241, 211, 839, 229, 323, 1297,
    1481, 1543, 181, 569, 1277, 799, 1553, 1117,
    943, 331, 1649, 47, 863, 521, 43, 1411, 2087,
    499, 683, 997, 761, 853, 1109, 1847, 739,
    71, 163, 241, 1349, 1997, 1823, 2017, 881,
    403, 61, 977, 199, 593, 937, 2291, 1681,
    1049, 1279, 743, 247, 1691, 1753, 601, 1619,
    1009, 713, 67, 1993, 599, 257, 769, 1283,
    941, 1303, 1621, 827, 919, 1207, 2231, 2113,
    2159, 797, 2209, 2287, 491, 1213, 1501, 1559,
    947, 563, 127, 613, 1321, 659, 2027, 1853,
    97, 191, 421, 1469, 1489, 2003, 667, 431,
    2173, 811, 779, 857, 2059, 1763, 1153, 2221,
    1019, 677, 2029, 1493, 2201, 1723, 2041,
    2297, 2179, 263, 2257, 971, 59, 1217, 949,
    1237, 701, 1423, 1921, 299, 2033, 1387,
    461, 1663, 1919, 2237, 2089, 2273, 1147,
    611, 631, 419, 1909, 877, 1901, 1123, 1861,
    1829, 2117, 1219, 1973, 1957, 2203, 1171,
    1229, 1937, 139, 233, 1933, 991, 1037, 1523,
    1417, 1181, 1693, 479, 1427, 1159, 1657,
    1751, 1843, 2131, 1769, 527, 773, 1721, 823,
    901, 29, 347, 1039, 173, 1357, 1871, 1051,
    859, 1583, 1927, 641, 1021, 2039, 227, 2269,
    83, 907, 103, 1591, 2279, 349, 1703, 1781,
    673, 1247, 1759, 1943, 157, 1601, 643, 1739,
    167, 1579, 1867, 911, 793, 871, 509, 1787,
    983, 967, 2141, 1873, 2161, 239, 1607, 1459,
    1223, 1777, 1 };
static uint32_t class_inv4620[960] = { 4619,2843,1087,3161,3013,2071,149,2747,2479,3653,
3637,523,1801,1439,1517,3709,443,3041,4453,571,
1667,3019,2153,2677,551,1063,1637,529,607,1961,
31,3029,2207,3713,4537,2351,2083,2581,3599,1669,
383,727,3761,3569,439,953,2137,1271,1963,2281,
3719,3797,589,3847,4093,2851,2489,467,559,653,
1151,883,4141,617,1129,3203,787,1273,3629,2687,
2077,2171,2683,1081,1139,2417,2663,2647,3401,193,
2791,449,1187,2719,1433,2711,4201,1679,4009,1163,
2347,221,73,391,647,4159,3233,277,4321,2699,
3197,1609,3383,1361,1093,2251,1339,53,4357,131,
2323,2579,2897,109,3127,281,1633,1291,89,3467,
2857,251,3763,3841,1499,137,4189,1643,307,821,
3151,1889,2119,2213,457,283,3961,3299,1697,2183,
1747,3673,751,809,3407,1819,2333,2411,3823,2461,
197,2389,1103,3701,3793,689,1007,3679,3337,3851,
4363,4021,317,2243,3907,1301,691,1709,2867,619,
4373,3877,1031,1261,2939,2329,3683,4027,4421,1333,
2249,1907,3739,293,2797,2623,961,4379,4457,4549,
3881,2773,3511,3767,3859,1313,3937,1811,223,899,
4577,1789,1447,4573,2971,4289,1367,1193,757,1511,
3343,1741,4439,3077,829,3323,1987,2081,1471,4409,
3379,113,3371,2803,3541,359,17,2689,503,3007,
733,3691,1307,3499,1913,311,361,1877,289,4043,
2887,2021,433,1949,1999,397,3431,1003,3239,1577,
3923,1807,4241,2293,1951,3389,4127,3559,2197,3551,
2521,839,229,323,3607,1481,3853,2491,569,3587,
799,1553,1117,943,2641,3959,2357,863,521,2353,
1411,2087,499,2993,997,3071,3163,3419,4157,3049,
2381,2473,2551,1349,4307,4133,2017,3191,403,61,
977,2509,2903,3247,4601,3991,1049,1279,3053,2557,
1691,4063,601,1619,1009,3023,67,1993,2909,2567,
3079,3593,3251,1303,1621,3137,3229,1207,4541,2113,
4469,3107,4519,4597,491,3523,1501,1559,3257,563,
127,613,3631,2969,2027,1853,97,191,421,3779,
1489,2003,667,2741,2173,811,3089,3167,2059,4073,
3463,2221,1019,677,2029,3803,2201,4033,4351,4607,
2179,2573,2257,971,59,1217,949,3547,701,3733,
4231,2609,2033,3697,2771,1663,1919,2237,2089,4583,
1147,2921,631,2729,4219,877,4211,1123,1861,4139,
2117,3529,4283,4267,4513,1171,1229,4247,139,233,
4243,3301,1037,1523,3727,1181,1693,2789,1427,1159,
1657,1751,1843,4441,4079,2837,3083,1721,3133,3211,
29,347,1039,173,1357,1871,3361,3169,1583,1927,
641,3331,4349,227,4579,2393,3217,103,3901,2279,
349,1703,1781,673,1247,1759,4253,157,3911,643,
1739,2477,3889,1867,3221,793,871,509,1787,3293,
3277,4451,4183,2161,239,3917,3769,1223,4087,2311,
2309,533,3397,851,703,4381,2459,437,169,1343,
1327,2833,4111,3749,3827,1399,2753,731,2143,2881,
3977,709,4463,367,2861,3373,3947,2839,2917,4271,
2341,719,4517,1403,2227,41,4393,271,1289,3979,
2693,3037,1451,1259,2749,3263,4447,3581,4273,4591,
1409,1487,2899,1537,1783,541,179,2777,2869,2963,
3461,3193,1831,2927,3439,893,3097,3583,1319,377,
4387,4481,373,3391,3449,107,353,337,1091,2503,
481,2759,3497,409,3743,401,1891,3989,1699,3473,
37,2531,2383,2701,2957,1849,923,2587,2011,389,
887,3919,1073,3671,3403,4561,3649,2363,2047,2441,
13,269,587,2419,817,2591,3943,3601,2399,1157,
547,2561,1453,1531,3809,2447,1879,3953,2617,3131,
841,4199,4429,4523,2767,2593,1651,989,4007,4493,
4057,1363,3061,3119,1097,4129,23,101,1513,151,
2507,79,3413,1391,1483,2999,3317,1369,1027,1541,
2053,1711,2627,4553,1597,3611,3001,4019,557,2929,
2063,1567,3341,3571,629,19,1373,1717,2111,3643,
4559,4217,1429,2603,487,313,3271,2069,2147,2239,
1571,463,1201,1457,1549,3623,1627,4121,2533,3209,
2267,4099,3757,2263,661,1979,3677,3503,3067,3821,
1033,4051,2129,767,3139,1013,4297,4391,3781,2099,
1069,2423,1061,493,1231,2669,2327,379,2813,697,
3043,1381,3617,1189,4223,2621,2671,4187,2599,1733,
577,4331,2743,4259,4309,2707,1121,3313,929,3887,
1613,4117,1931,4603,4261,1079,1817,1249,4507,1241,
211,3149,2539,2633,1297,3791,1543,181,2879,1277,
3109,3863,3427,3253,331,1649,47,3173,2831,43,
3721,4397,2809,683,3307,761,853,1109,1847,739,
71,163,241,3659,1997,1823,4327,881,2713,2371,
3287,199,593,937,2291,1681,3359,3589,743,247,
4001,1753,2911,3929,3319,713,2377,4303,599,257,
769,1283,941,3613,3931,827,919,3517,2231,4423,
2159,797,2209,2287,2801,1213,3811,3869,947,2873,
2437,2923,1321,659,4337,4163,2407,2501,2731,1469,
3799,4313,2977,431,4483,3121,779,857,4369,1763,
1153,4531,3329,2987,4339,1493,4511,1723,2041,2297,
4489,263,4567,3281,2369,3527,3259,1237,3011,1423,
1921,299,4343,1387,461,3973,4229,4547,4399,2273,
3457,611,2941,419,1909,3187,1901,3433,4171,1829,
4427,1219,1973,1957,2203,3481,3539,1937,2449,2543,
1933,991,3347,3833,1417,3491,4003,479,3737,3469,
3967,4061,4153,2131,1769,527,773,4031,823,901,
2339,2657,3349,2483,3667,4181,1051,859,3893,4237,
2951,1021,2039,2537,2269,83,907,2413,1591,4589,
2659,4013,4091,2983,3557,4069,1943,2467,1601,2953,
4049,167,1579,4177,911,3103,3181,2819,4097,983,
967,2141,1873,4471,2549,1607,1459,3533,1777,1,
};
static uint32_t class_inv30030[5760] = { 30029,26497,3161,26113,2071,23249,23537,11719,24443,19807,
2833,29521,8369,10757,19879,18923,3041,20623,25981,24767,
14569,13703,7297,551,1063,10877,21319,14467,25061,9271,
28439,16067,24503,23017,2083,16441,24389,6289,7313,19207,
26861,12809,14813,11377,17441,8893,25381,12959,23689,13087,
15643,14401,9419,28187,25969,12203,10391,23983,14477,21919,
21683,16957,26683,3629,7307,2077,20651,9613,12631,8069,
7037,25763,19571,27913,7411,5069,19667,7339,28121,18061,
22469,10939,10403,9277,2531,27793,9631,2957,24949,26333,
9517,18181,23987,24709,19553,3671,3403,29971,24439,20843,
6667,2441,23369,9827,109,3127,27043,5911,20879,5777,
5167,23351,17623,15391,1499,20927,8573,18787,12371,3151,
20369,22909,25313,18937,18763,10891,12539,4007,11423,20227,
1363,21599,21887,15679,13883,7031,15373,25561,23297,20869,
19583,19871,6103,2999,17177,19849,24641,22843,13261,11867,
6217,8231,14551,24809,2867,16789,20543,8497,5651,17431,
5249,2329,1373,1717,20591,17503,13457,10669,18773,16657,
2623,19441,8999,20627,4549,24671,10441,17627,22339,17483,
6247,7153,23999,2267,15649,15307,20743,7591,8909,26777,
3503,23857,6131,26443,13291,9059,12379,21803,18157,2081,
26881,9029,5689,113,3371,23593,16529,27737,23479,21293,
9937,14593,1381,19787,17359,22703,25721,16531,24977,25699,
13283,2021,16603,1949,11239,2707,24221,19483,24029,22367,
15473,27217,15791,20773,11191,10319,4127,8179,9127,12791,
27931,7159,21113,19777,13031,8473,18661,12119,12827,12349,
17723,24217,2641,10889,27767,12413,23143,15271,18257,5119,
683,10237,3071,853,1109,4157,13931,18643,16411,8279,
24923,20497,28601,28123,6991,7907,27919,7523,17107,9221,
10289,3589,9983,4867,10931,4063,601,27029,3319,19193,
25477,15853,26009,18737,3079,8213,7871,24403,6241,21617,
17089,5827,20711,15973,29879,21587,20689,4597,23591,26623,
6121,17729,26357,28283,27847,21403,24421,22817,20333,16267,
2501,7351,22259,6109,22793,19147,25841,10051,3089,857,
2059,22553,19633,18391,3329,28397,4339,3803,25301,8653,
25141,9227,21053,20737,24071,27779,21739,19717,14561,17593,
1921,18779,29753,22177,16631,24763,18089,20717,6709,9203,
15007,16781,2941,23519,13459,28597,29621,8053,13411,1829,
13667,8149,1973,4513,1171,5849,18107,16309,1933,7921,
10277,8453,26827,17351,4003,23579,3737,1159,27067,22541,
27253,27541,25937,26183,1721,12373,14761,29,347,1039,
173,12907,18041,28771,28579,8513,29647,14881,22829,23327,
23059,13943,3217,2413,20071,2279,13253,27191,28393,24859,
4253,25567,24701,16813,10979,4787,15439,29587,21701,16963,
28229,15647,28703,967,16001,13423,2161,9479,13157,8389,
28943,8707,18481,9239,9773,851,7633,11311,11699,21227,
18649,15187,12073,11041,3749,17687,17569,14303,12281,9073,
23671,22457,26119,2153,16537,19031,26473,22427,529,26017,
20441,6961,23819,25307,6023,20707,25451,27991,12839,1669,
5003,26137,22049,439,21743,9067,12821,27373,13831,24509,
6107,24637,24883,9781,7109,21349,23753,19631,5503,24931,
9857,10369,893,5407,24373,1319,25787,27487,18341,16543,
8011,19619,16277,21143,16507,26501,25603,25891,14309,1187,
5029,19913,25811,27301,10919,17869,4657,14081,7003,21181,
9887,22639,21713,27997,15871,16559,21677,6229,8003,22151,
28813,6871,3649,53,18217,27851,9253,18749,19067,18589,
817,14141,17461,9329,24257,12097,13003,24631,10739,16307,
22669,15503,16477,7751,21631,1889,23003,457,28003,6271,
10229,22973,29467,12913,751,28529,17267,4129,23123,18581,
13063,11747,79,8033,17561,13033,14549,26417,1369,10267,
1541,20533,1711,23417,23033,5921,23791,13259,557,23719,
3877,17201,28981,629,19,26783,20197,29831,5953,11489,
11147,22219,7223,25897,28033,26371,2147,13789,20051,14323,
8131,26867,10789,29033,3937,13361,12449,20747,11029,22237,
16123,16831,18149,22157,10433,21547,1511,14893,1741,20609,
10007,19493,29707,20561,22261,6719,1069,11663,12611,5113,
8161,23459,23117,11929,503,28417,12283,8237,26599,11153,
23411,11911,4187,7219,8663,5197,8951,14293,11189,8929,
21911,1003,12479,20057,22597,27341,30013,22741,5699,11057,
5869,27607,22031,25621,21629,18709,9563,29017,1481,3853,
25591,24377,21589,26963,5737,21733,331,6269,6977,23963,
2831,26821,6707,499,28403,17167,26263,10349,29567,23839,
9311,7093,4861,19829,15857,22613,2017,17051,7333,2371,
23299,19073,26347,18461,13231,17219,22069,19223,23347,22481,
1753,24719,12559,7643,20857,22783,7529,27977,14629,3593,
14801,22093,24721,3137,14779,18401,27523,18329,19277,27619,
30007,5111,5833,17671,13109,3257,23663,16297,9853,22111,
7589,20507,8783,25507,20981,14281,15349,2003,667,21221,
27583,7741,28499,10097,20539,4073,29941,21809,16847,29749,
1493,4033,4351,4607,16039,27983,18427,19451,9299,15077,
1237,3011,26833,27331,16469,11273,1387,25871,6283,25019,
16097,25189,18443,3457,28331,21209,22699,23977,27311,14983,
8791,13379,22907,19699,27383,22747,2203,19651,15089,29657,
13999,16403,13483,17161,7967,22207,28901,13243,18959,10667,
28879,15517,1751,15703,25231,4079,23627,14633,20201,7753,
21691,11897,10279,9413,24457,13421,26461,17029,20063,27337,
12191,26431,11279,11777,18439,11633,10147,27823,29311,11519,
23449,20183,22571,16843,17417,1943,7087,13151,26053,8669,
10819,8797,911,28513,10111,5129,11027,7913,19447,27551,
11113,7169,1607,17629,17393,4087,13861,20789,5153,14947,
7781,5323,29791,20939,2747,16339,12893,23623,20281,22229,
15377,24499,23831,18313,5191,29387,23809,27563,4987,28271,
14923,20117,12079,5227,8891,13891,6827,15263,2227,20831,
20563,25681,8219,20149,16553,23827,15311,10499,25849,19433,
15997,22753,23071,3719,1487,12139,22327,13333,28261,18659,
16637,21443,8081,14743,20311,5749,12443,14647,5893,8249,
21167,15937,29891,14233,17309,4727,9593,11887,24191,2503,
21271,25859,10427,16579,15293,2711,15751,20159,15559,28883,
11771,18553,391,7577,29569,23377,27421,11939,28607,3919,
3383,1361,17263,4561,15199,18533,27457,16301,4633,587,
27829,12367,9521,15493,15151,4709,3467,9787,11801,6151,
29219,4757,18049,13193,23407,841,11129,11359,29933,28177,
16453,24751,21779,22487,20663,10987,22153,26161,26219,29539,
4643,27821,24613,14011,7127,18559,17273,29111,10723,12239,
14867,10609,5647,29261,27463,27121,2627,18413,24697,12851,
12241,22499,12107,21409,8993,14891,8191,19109,6949,15577,
11351,15193,6869,18077,19909,2603,14347,16483,24061,27479,
29867,25339,8501,9703,15061,8387,20029,8243,15487,8741,
25633,7829,29987,29509,19927,28381,6599,10607,8123,28477,
10273,10981,29849,5387,829,26423,27397,15941,10711,18269,
9353,1061,14353,3541,21149,7309,12053,7627,23833,19861,
3617,15049,20393,4931,22667,16459,27143,577,6641,21223,
22739,20479,21187,28841,28723,21719,1577,3923,25031,11533,
1951,24179,8747,12799,22987,3551,7141,17009,16399,4943,
17467,10721,22333,23281,569,22067,3109,15413,14977,17113,
7261,18527,3173,28241,11593,24511,15947,18979,9923,14857,
21551,28829,18017,19219,2473,14101,29069,11237,29543,29737,
12431,25813,20851,26387,16763,7867,6911,8611,14909,17449,
743,2557,1691,13303,19081,1619,1009,16883,9307,20473,
5219,16427,23869,22073,12491,29023,20101,12377,26329,24307,
25331,25213,27569,797,25309,2801,17383,26911,1559,947,
11677,19093,3631,2969,27437,4163,13957,191,11971,10709,
26899,20483,9907,9671,22963,14671,21647,29779,13313,8083,
27631,17189,26087,18199,13043,13751,15901,23087,11419,25673,
25357,18539,10457,10189,28957,28421,15283,15781,28019,8963,
12937,14321,15523,22709,20569,29993,12697,7541,21421,28139,
11149,12427,8831,12673,11069,11357,28939,15833,18127,9133,
15031,26639,8867,25549,11783,11173,5611,19517,26933,26591,
24793,7409,8357,5779,10897,13301,24943,6751,29489,527,
10013,29441,26233,19381,18509,9587,21829,27893,3667,1871,
3361,26269,29303,8857,7571,24121,6659,21017,6889,23183,
7837,10831,29999,18829,17873,12223,12797,13309,8873,4777,
8531,14503,20219,23267,20347,19391,7723,5491,2819,19463,
28687,6761,22663,20641,14099,27017,6079,26633,22567,18479,
23633,10327,5471,12253,25171,2459,11987,27889,8273,3637,
21313,8731,1439,26927,22189,2753,21521,29863,14431,27077,
709,367,9791,24163,27047,9769,23707,18131,11581,12269,
4517,3713,11467,9281,15943,2581,29389,25793,5347,10691,
5879,14299,953,13687,1271,4591,22199,19967,7519,29257,
8713,7471,27899,12017,9799,28373,3461,3193,8761,28337,
10133,26197,15133,5939,25177,9101,25783,26491,24239,107,
18833,337,5711,193,23549,28907,25819,3743,401,11131,
1679,27109,24263,23137,18701,16243,18871,19127,27259,10163,
6631,389,26297,10849,12911,26503,16111,12889,13913,15907,
25541,23113,7199,28307,9349,21607,28001,10873,22081,15017,
21337,7181,1453,3841,24599,13997,6499,24743,21097,26231,
12391,29609,6739,27623,5077,11833,3961,989,17867,27593,
8677,10603,14611,7739,5717,2333,16271,3823,9391,13939,
28823,8321,22273,19169,10247,29089,24127,10781,25153,21107,
6863,20077,10541,7621,4019,21347,2929,4373,22357,21821,
26671,28349,4639,15233,9041,26743,25349,15767,26839,9727,
25723,5581,22859,6767,23029,17741,28183,12751,6077,1549,
26723,24727,27221,21013,11507,8719,1447,4573,26071,1979,
19847,19673,26167,19991,22531,18299,23867,26239,24113,4297,
19951,27509,19549,16283,26471,2803,22021,2669,11567,9743,
19177,3043,15241,10429,1913,14171,361,18047,4909,6353,
19057,18191,18913,20429,29719,16567,26531,5623,3239,10817,
29333,11047,1931,9223,20431,3389,20297,10489,1241,16381,
5459,23329,12847,22271,1543,4801,25979,28997,799,10793,
3427,5563,4951,24749,16217,21653,16691,6973,1411,27497,
28219,19163,26407,16931,14713,24209,27257,7669,27791,25651,
17519,29717,27233,6637,21193,61,21767,11749,23693,5557,
2291,27091,26459,28463,14107,20171,22543,14461,29339,26419,
28433,18547,1993,12149,11807,12319,1283,24041,26713,827,
5539,19687,23021,2113,9089,10037,6829,18457,9731,15073,
15361,10799,12497,12113,613,12871,21449,25127,9337,11741,
23521,6089,24589,15863,28387,18911,11413,12361,16949,19337,
11299,1763,3463,4531,7607,27439,22283,9131,22513,13591,
2297,29899,7193,23047,7901,6989,28937,5569,5857,10663,
25021,7229,15893,10627,9701,3973,4229,4547,27683,24247,
26021,16801,25829,6529,21667,18071,24223,27271,17999,6737,
17389,25073,6577,6823,24329,27347,4759,233,18103,991,
28757,22313,10657,3491,22483,16649,19907,3469,10991,6463,
15991,17939,28247,10961,5443,901,13889,16517,19519,23273,
22147,11111,1051,7789,17753,18097,26051,1021,2537,16129,
2393,19387,16273,8521,25379,7279,29423,11021,1247,8689,
6563,11707,9883,29459,18647,29299,18037,14771,26203,23971,
14369,29507,17153,10207,25241,1873,16021,11789,1459,8153,
1777,2311,25409,2843,28807,17021,9943,149,437,7099,
26753,29047,28243,4111,12989,6137,3709,28163,28451,27553,
2881,8597,28429,16013,7481,5683,24737,16699,19087,29681,
23131,7649,11447,29123,29947,18521,4393,271,26699,10909,
14243,14587,29171,23539,10193,25237,26681,11203,2281,17579,
29207,25999,26947,19021,16349,467,5179,26063,28603,18001,
23717,24229,17063,23887,3583,17489,9617,6697,27581,4993,
21871,21929,353,9577,14951,11743,9721,449,24287,14269,
12983,11951,29399,6319,12713,18517,16391,23173,14251,28367,
8779,5543,11827,25111,9629,7817,8539,21863,10601,8023,
25351,19819,11287,7061,2323,2579,5207,7039,10057,7211,
29353,19771,23189,12707,547,25661,26863,10771,25547,15739,
3953,2617,21611,10081,24989,25219,9143,2767,15511,19469,
6317,25283,15607,5983,23851,16979,1097,17989,9263,11651,
22303,27871,25607,26513,26801,1483,16859,24469,3337,20021,
6673,15571,16487,16103,8527,22091,1709,9797,12169,22853,
17737,19511,22051,9869,16189,10613,4027,15971,24433,4559,
27317,24529,21083,7243,14821,11309,4457,29959,29291,7393,
24301,13007,29269,22103,13177,6431,9463,26309,9197,20269,
10687,29983,2971,1367,28913,7687,15371,28753,20221,13679,
3077,14689,5633,1987,4391,1471,15959,14929,13973,28213,
1231,11909,6947,25789,16673,16867,21523,3691,22097,29633,
2621,25771,289,17903,28297,27431,433,27359,18169,5017,
8051,3313,929,29297,17783,6427,29651,16153,15811,14939,
29537,22039,11437,8171,4831,14699,21019,23423,19961,13093,
14041,14429,26687,7729,28837,14803,16501,20129,23147,17033,
25931,25453,29131,25187,9739,7613,5617,5381,10093,8777,
16909,23171,20953,23341,12899,8927,8753,4327,881,11611,
10217,7129,21383,12487,6301,5669,5899,5363,11797,15551,
10993,2911,10859,26123,67,11233,9839,7699,12833,3251,
8233,8551,26237,24019,8137,4541,29833,6779,28517,16069,
13837,7421,22003,10741,22349,21737,7493,127,28333,1321,
659,6647,22643,9431,2731,24569,1489,23767,431,20653,
23911,12329,26267,8989,27173,21943,2221,5639,5297,8959,
10733,27611,17893,20521,13847,9109,16433,4567,3281,2369,
8147,24049,3547,16871,6541,25709,13583,17557,29383,13469,
29957,9019,4583,21937,21401,5251,7349,3187,6521,3433,
22651,15689,12769,6593,15817,18373,3481,1229,22727,23239,
9473,15793,17207,10763,6037,1181,29413,28199,29147,15019,
29377,17921,4153,4441,27179,9767,28493,8651,16993,10141,
2339,14207,26449,17527,22661,12601,5479,13133,6547,5261,
28741,25139,227,27679,20873,28627,11653,15451,16519,8633,
6401,673,10487,27169,18113,9397,27011,17909,7097,24679,
24967,21583,3181,23609,24887,24083,7897,20621,20353,4471,
23339,15467,5843,13327,27721,23099,14393,8017,26261,21493,
13621,7079,25847,25579,5963,17497,25933,10679,24617,12949,
16613,26141,4453,28291,17837,9949,11393,18847,14411,3373,
6257,14389,27371,2341,26129,9137,25327,41,13633,11821,
22079,8599,9623,3037,8381,24359,5059,28673,4447,15131,
6583,9211,10727,5209,8467,27193,16711,11729,9707,23659,
7583,21941,29551,12167,19609,14753,787,28993,26729,4997,
4387,22961,23473,10321,3449,18587,28073,21127,3401,20983,
5101,28169,9649,24533,21191,29611,6299,24799,21953,6967,
27941,20863,16817,18019,24023,7207,20491,21179,17057,20089,
17243,17531,5713,13801,17509,2363,4751,13873,21059,2897,
13969,5437,18761,8563,1291,18569,19637,19027,4871,15313,
8461,13049,23237,27289,22433,11857,10061,17011,4429,18383,
14317,283,13201,14849,15557,6803,13297,5371,5429,19577,
13369,6953,17683,7081,20987,2389,3413,22181,19963,28409,
28727,14887,8471,15913,10951,27653,17767,1301,26101,8639,
5177,619,2063,6187,1031,7559,25429,29093,29437,13661,
1333,16109,6527,6049,16463,28207,4933,3271,20549,16007,
27649,26981,18943,3511,10697,6169,8557,17981,18703,21689,
16127,17959,29167,18433,661,20459,29087,17363,16927,3821,
24133,27151,14627,23929,14873,13537,29801,29191,11339,3379,
25523,14921,12781,359,25427,21169,14363,23797,16903,12931,
17477,28909,6533,28031,14221,6497,15593,9817,15881,9673,
25049,13549,14257,17291,14863,7859,24677,27023,24907,11171,
13843,12629,17987,1249,6817,5861,211,26249,2539,18803,
1297,26891,10783,2491,23669,8207,5419,29273,26353,25741,
8579,20837,7451,4663,10651,2087,7429,2993,24097,14621,
28573,12659,6467,28459,11621,16333,241,20477,17993,15877,
26291,9643,9301,19457,25609,2903,10177,20771,17851,24149,
1279,3053,18727,6373,12151,20099,14869,3023,27787,29713,
21389,257,10523,21731,17473,3931,19399,17377,13781,11353,
13709,23897,4519,2287,18971,19693,20039,10187,25973,25537,
5233,26731,12209,15887,18023,27817,16361,21211,3779,29209,
4313,28151,2173,3121,779,23957,15919,1153,13771,1019,
12227,6649,6113,6821,6343,18211,11537,20659,4883,13807,
21761,19697,3259,15097,12251,29143,4231,21089,25133,15247,
28181,1919,18407,4399,2273,28867,14491,16589,25009,877,
1901,21913,11101,27239,25217,4283,27367,27613,28891,28949,
18619,21023,27343,19471,12587,20003,24517,12731,27103,25889,
17597,24259,24757,15611,11083,29851,8699,19007,23873,15581,
14683,28621,11579,25757,24139,11723,20351,21841,12409,1927,
16811,10261,20519,7157,25369,16253,17077,103,13141,13829,
28069,27113,24881,26083,22037,6379,27353,20947,22391,28363,
13289,16337,13129,22657,3221,14731,12059,13337,21773,14827,
15733,13711,2549,10847,19939,12773,11017,16171,4619,12083,
19567,14711,703,9001,4769,20959,17513,26737,7453,22591,
17609,19997,1399,25853,7661,2143,6287,19189,29873,14227,
12101,10303,15497,25939,7537,4271,20821,5339,20687,17573,
27761,25183,21061,10529,15529,28447,19931,19739,2749,24053,
22927,24371,25063,6901,6029,8417,16759,17707,22573,23641,
21257,2869,16823,17321,17053,27241,21407,8059,26303,28507,
15179,23477,11317,18853,19561,12689,13967,4973,18817,28811,
9433,23581,9689,12737,22223,9641,24991,3989,20179,3473,
16207,7151,2383,2701,12197,6469,3233,25687,18869,5507,
29329,5693,15221,12643,9181,29059,27773,29767,11681,11563,
269,14447,11659,16451,20113,10531,7019,17327,14407,16421,
24553,20011,8429,137,24979,17813,307,19301,14701,13439,
15979,6833,23557,25693,20131,27107,16043,24847,24463,3061,
809,28817,1819,18503,101,18631,9437,27799,1103,15343,
7619,24107,12919,12577,3851,4363,29431,4937,25343,29317,
19781,21481,6329,26029,13613,15427,10271,10501,14489,13879,
8303,17887,25211,29053,13799,25007,15289,4913,23587,11863,
28681,2069,25247,9169,3881,16633,21991,22247,3859,10553,
15671,223,10139,13817,24889,24547,27673,12211,15839,5987,
12743,5377,13061,12583,24841,2129,12317,5449,3323,22777,
18251,6091,12619,4733,10301,16663,10471,25769,4637,9619,
25913,21487,24481,5927,24289,4223,23461,1877,18769,22523,
7507,11261,28153,6569,25807,5741,24103,5549,8543,4117,
20411,25393,4261,19559,13367,19729,25297,17411,23939,11779,
7253,26707,24581,17713,27901,5189,17447,16969,24653,17287,
24043,14191,17819,2357,5483,5141,16213,19891,29807,14359,
19477,26171,7783,8039,13397,26149,20861,4783,27961,1349,
18167,6443,25117,14741,5023,16231,977,4819,12143,21727,
16151,15541,19529,19759,14603,16417,4001,23701,8549,10249,
713,4687,25093,599,25667,26179,17453,17111,5923,22411,
14687,28927,2231,20593,11399,29929,11527,28211,1213,29221,
26969,5567,5183,13987,2923,9899,4337,6473,23197,14051,
16591,15329,10729,29723,12217,5051,29893,21601,10019,5477,
13609,15623,12703,23011,19499,9917,13579,18371,15583,29761,
18467,18349,263,2257,971,20849,17387,14809,24337,701,
24523,11161,4343,26797,23561,17833,27329,27647,22879,13823,
26557,9851,26041,5039,20389,7807,17293,20341,6449,20597,
1219,11213,25057,16063,17341,10469,11177,18713,6553,14851,
1523,3727,21971,8623,2789,12977,12709,13207,27161,8773,
6389,7457,12323,13271,21613,24001,23129,4967,5659,7103,
5977,27281,10291,10099,1583,14501,19501,8969,4847,2269,
12457,9343,24691,9209,25759,22493,4091,14533,19727,17929,
15803,157,10841,23743,27887,22369,4177,28631,10033,12421,
7439,22577,3293,12517,9071,25261,21029,29327,15319,10463,
17947,25411,13859,19013,17257,10091,19183,27481,16319,14297,
15203,8257,16693,17971,15299,26809,7373,16901,13693,16741,
1667,7639,9083,2677,23651,7993,3947,5149,2917,1961,
16201,16889,29927,12953,13777,4661,22873,9511,19769,13219,
28103,17621,8189,9679,18307,5891,4273,18451,1409,15347,
14449,6157,11023,21331,179,18947,14419,5273,5771,12433,
4141,2927,17299,5513,10027,17443,10559,2687,9007,11411,
1081,1139,2417,2663,25747,4813,2791,18929,8117,28129,
29153,5021,13441,15539,1163,27757,25631,11623,28111,1849,
14783,4897,8941,25799,887,17779,14933,26771,10333,8269,
16223,25147,9371,18493,11819,23687,23209,23917,23381,17803,
29011,16259,28877,14111,6073,29251,26909,27857,1879,25717,
821,26251,8819,13669,2213,12007,14143,17821,3299,24797,
4493,4057,19843,9991,10337,11059,27743,25511,6133,16321,
18677,16249,12653,10631,26099,12557,8299,19507,29773,8641,
317,2243,27007,15161,9931,17879,23657,11303,26977,28751,
5881,12179,9259,19853,27127,4421,10573,20729,20387,3739,
14153,12037,9553,29789,13697,18409,1571,23563,17371,1457,
15409,5933,27037,22601,27943,19379,25367,22579,9193,21451,
4289,3677,757,24611,21823,6361,27539,19247,3139,28733,
11227,27491,3781,29819,24169,23213,28781,12043,17401,16187,
18859,5123,3007,5353,22171,15167,12739,15773,16481,4981,
20357,14149,20213,14437,23533,15809,1999,23497,1121,12553,
17099,13127,6233,15667,8861,4603,29671,17249,15109,4507,
26651,18691,839,229,16493,15157,6101,15403,2879,5897,
26209,13103,12667,943,9571,29369,11597,863,12071,13903,
8341,11327,12049,21473,23861,19333,26519,11087,3049,2381,
14023,9481,26759,25097,1823,13567,23981,23503,13921,28697,
16369,593,937,4601,22471,28999,23843,27967,29411,24853,
21391,3929,28729,12263,2377,19079,14117,21559,15143,1303,
1621,10067,7849,26617,27641,9043,22949,12347,23077,16661,
10453,24601,24659,16733,23227,14473,15181,16829,29747,15713,
11647,25601,13019,19969,18173,7597,2741,6793,16981,21569,
14717,25159,11003,10393,11461,28739,21467,11269,24593,16061,
27133,8971,16157,25279,27667,12521,16229,24317,12499,12787,
9941,12973,8851,9539,22823,6007,12011,13213,9167,2089,
23063,8077,5231,23731,419,8839,5497,20381,1861,24929,
9047,26629,8903,1957,11443,26581,19709,6557,7069,25643,
25033,3301,1037,29243,15277,10421,17863,479,8089,22447,
6371,20323,18301,13319,2837,21563,24821,19303,20819,23447,
14899,25583,1357,24971,5671,21649,26993,20407,21431,7951,
18209,16397,29989,4703,20893,3901,27689,2659,15641,23773,
26657,15619,11183,18637,20081,12193,1739,25577,3889,13417,
17081,5413,19351,4097,12533,24067,4451,4183,22951,16409,
8537,3769,22013,15637,6931,2309,16703,24187,14563,6691,
25559,9677,9409,22133,5947,5143,6421,26849,8447,5063,
5351,22933,12121,3019,20633,11917,2861,19543,29357,23629,
21397,13511,14579,18377,1403,9157,2351,29803,4891,1289,
24769,23483,16897,24551,17429,7369,12503,3581,15823,27691,
19889,13037,21379,1537,20263,2851,25589,25877,12109,653,
15011,883,1831,617,28849,23993,19267,12823,14237,20557,
6791,7303,28801,26549,11657,14213,23437,17261,14341,7379,
26597,23509,26843,22681,24779,8629,8093,25447,21011,73,
16561,647,12473,16447,4321,23489,13159,26483,5981,21883,
27661,26749,25463,13597,20921,16183,9509,12137,2419,19297,
21071,24733,24391,27809,8087,2857,21041,3763,17701,6119,
9377,29599,6263,28541,5461,27299,20599,7387,23383,29371,
28709,1697,29903,22537,8293,7681,19289,8027,22609,16193,
13961,1513,23251,197,25489,21893,6011,3793,21479,21797,
26779,17197,22331,20191,18797,29963,3907,19171,27119,19037,
14479,18233,24667,24131,24361,23729,17543,8647,22901,19813,
18419,29149,25703,21277,21103,17131,6689,9077,6859,13121,
21253,19937,24649,24413,22417,20291,4843,899,4577,4099,
12997,6883,9901,13529,15227,1193,22301,3343,15601,15989,
16937,10069,6607,9011,15331,25199,21859,18593,7991,493,
15091,14219,13877,379,23603,12247,733,29101,26717,21979,
25013,11861,2671,29597,2599,1733,12127,29741,4259,27409,
397,7933,26339,8507,13163,13357,4241,23083,18121,28799,
1817,16057,15101,14071,28559,25639,28043,24397,15341,26953,
16351,9809,1277,14659,22343,1117,28663,27059,47,19343,
9761,20833,3721,20567,23599,16853,7927,761,17023,5729,
22637,739,71,25573,18721,15209,22787,8947,5501,2713,
25471,5597,14059,26003,19417,13841,20161,7979,10519,12293,
7177,17861,20233,28321,7939,21503,13927,13543,14459,23357,
10009,26693,5561,13171,28547,3229,3517,4423,2159,7727,
18379,20767,12041,28933,13051,6179,24047,14423,4747,23713,
10561,14519,27263,20887,4811,5041,19949,8419,27413,26077,
14291,4483,19259,3167,4369,29483,17323,6841,10259,677,
22819,19973,22991,24823,27451,27707,22969,18743,10211,4679,
22007,19429,8167,21491,22213,20401,4919,18203,24487,21251,
1663,15779,6857,13639,11513,17317,23711,631,18079,17047,
15761,5743,29581,20309,18287,15079,20453,29677,8101,8159,
25037,2449,23333,20413,12541,26447,6143,12967,5801,6313,
12029,1427,3967,24851,29563,13681,11009,3083,4031,823,
12451,27749,18827,3349,4793,19837,6491,859,15443,15787,
19121,3331,29759,25637,11509,83,907,18583,22381,6899,
349,10943,13331,5293,24347,22549,14017,1601,21433,27149,
2477,1579,1867,26321,23893,17041,25919,1787,983,3277,
22931,29593,29881,20087,13009,1223,27187,4621,27719,28253,
21877,28571,18241,14009,28157,4789,19823,12877,523,15661,
6059,3827,15259,11993,731,11383,571,20147,18323,23467,
21341,28783,19009,607,22751,4651,21509,13757,10643,27637,
13901,27493,29009,3979,11933,12277,22241,28979,18919,7883,
6757,10511,13513,16141,29129,24587,19069,1783,12091,14039,
23567,19039,26561,10123,13381,7547,26539,19373,7717,1273,
29039,11927,29797,25271,2683,5701,23207,23453,4957,12641,
23293,12031,2759,5807,11959,8363,23501,4201,13229,4009,
5783,2347,25483,25801,26057,20329,19403,14137,22801,5009,
19367,24173,24461,1093,23041,22129,6983,22837,131,27733,
16439,7517,20899,7747,2591,22423,25499,26567,28267,18731,
10693,13081,17669,18617,11119,1643,14167,5441,23941,6509,
18289,20693,4903,8581,17159,29417,17917,17533,19231,14669,
14957,20299,11573,23201,19993,20941,27917,7009,10343,24491,
29203,3317,5989,28747,17711,18223,17881,28037,11483,1597,
3611,691,15569,7487,9859,15923,1567,3571,2939,27739,
24473,6337,18281,8263,29969,8837,23393,2797,313,12511,
4379,2239,22361,2773,5821,15317,13099,3623,10867,1811,
2533,28619,23057,13339,8377,13813,5281,25079,24467,26603,
19237,29231,1033,4051,25229,28487,7759,17183,6701,24571,
13649,28789,19541,9733,26641,9599,20807,28099,18983,697,
19213,26791,24407,3499,13463,311,9601,11117,11839,10973,
23677,25121,11983,29669,15859,28117,19601,14789,26987,10853,
20287,18463,27361,8009,27227,3559,13747,10481,2521,10079,
25733,5917,3791,6163,11731,7499,10039,3863,10357,10183,
28051,3959,25457,28583,21311,18523,9017,2809,5303,3307,
28481,23953,17279,1847,12289,7001,23263,7171,24449,4307,
20303,3191,14263,4681,3287,20989,14797,25391,1681,3359,
8209,7673,25657,27101,8683,26011,22409,19489,9953,23167,
8923,4877,19249,5903,941,19783,10861,7757,21709,1207,
16091,20639,26207,13759,27697,24313,22291,15419,19427,21353,
2437,12163,29041,26069,18197,24953,2407,23291,421,17639,
3799,8933,5287,23531,16033,5431,26189,28577,22849,8693,
15013,7949,19157,2029,8423,20681,1723,22831,6917,4489,
14123,16117,17141,13919,3527,17119,19181,3733,29641,23399,
19867,2771,10903,11159,13787,11329,6893,5767,2921,28351,
18899,29629,26287,4211,1123,6481,29837,24319,29693,11197,
29923,5791,3539,4247,20929,4853,24091,14897,3833,19897,
1693,21269,26837,26569,1657,20231,18013,2131,22559,21317,
773,22511,10063,7831,25439,28759,16343,29077,15731,24151,
19339,24683,4237,641,27449,14087,20749,18563,26317,25513,
17761,18449,11899,6323,20261,2983,5867,20239,29663,29321,
2953,15599,167,8509,27277,7841,3103,28591,21299,8717,
26393,21757,2141,18043,27571,4859,17777,24559,19703,6397,
11551,7463,3397,23951,3013,15931,9389,7367,23269,1343,
10567,27211,24539,22307,10639,9683,6763,9811,15527,21499,
25253,21157,16721,17233,17807,12157,11201,31,19199,22193,
6847,23141,9013,23371,5909,22459,21173,727,3761,26669,
28159,26363,2137,8201,20443,11521,10649,3797,589,20017,
29503,541,23279,5087,16729,19133,24251,21673,22621,5237,
3439,3097,10513,24419,18857,18247,4481,21163,3391,14999,
20897,11903,14197,1091,18673,18961,17357,21199,17603,18881,
1891,8609,22489,17333,37,9461,7321,14507,15709,17093,
21067,2011,14249,14747,1609,1073,19841,19573,11491,4673,
4357,18611,6943,14129,16279,16987,11831,3943,12841,2399,
21947,16717,251,8383,15359,7067,20359,20123,9547,3131,
19321,18059,29839,16073,25867,2593,27061,26399,10937,18353,
29083,28471,3119,12647,27229,4721,29233,2461,4817,4699,
5723,3701,17653,9929,1007,17539,7957,6161,13603,24811,
9557,20723,13147,29021,28411,10949,16727,28339,27473,29287,
12581,15121,21419,23119,22163,13267,3643,9179,4217,17599,
293,487,18793,961,15929,27557,10811,12013,1201,8479,
15173,20107,11051,14083,5519,18437,1789,26857,11503,22769,
12917,15053,14617,26921,7963,29461,6749,7697,19309,12563,
25087,13631,13021,22889,26479,7043,17231,21283,5851,28079,
18497,4999,26107,28453,8311,1307,1189,8843,9551,7291,
8807,23389,29453,2887,13571,7363,25099,9637,14981,26413,
10169,6197,22403,17977,22721,8881,26489,15677,28969,20677,
11761,19319,14089,2633,3607,29201,24643,181,19049,19757,
1553,21907,19423,23431,1649,10103,521,43,22201,4397,
21289,14543,21787,10001,21643,14969,20327,21529,4691,163,
2551,5969,13547,15683,27427,10121,11953,23161,14837,18679,
14453,23081,10921,21839,15139,21037,8621,17923,7531,17789,
17179,5333,11617,27403,2909,2567,769,24383,19421,15163,
17791,19307,919,12757,11471,22903,16019,5417,2209,25387,
491,3811,3869,7877,19043,9367,7543,8251,5279,13577,
1853,97,18671,18901,29189,6623,16837,11981,25273,811,
23879,18229,20243,26563,25321,14879,14537,20509,17663,2201,
29443,25397,13729,2573,11497,14831,25469,12767,28669,26647,
26111,1423,18091,2609,6653,461,22453,29639,11477,18259,
1147,14471,9871,14279,27319,14737,13451,19603,4171,8759,
27527,5839,18143,20437,25303,12721,15797,139,14093,8863,
21781,24137,15383,17587,24281,9719,15287,21949,8587,13393,
11371,1769,16697,7703,17891,28543,26311,6959,7277,14033,
10597,4181,19531,14719,6203,13477,9881,21811,4349,9467,
9199,27803,14767,23203,16139,21139,24803,17951,9913,15107,
1759,25043,2467,6221,643,24839,11717,6199,5531,14653,
7801,9749,6407,17137,13691,27283,9091,239,24707,22249,
15083,24877,9241,16169,25943,12637,12401,28423,22861,18917,
2479,10583,22117,19003,24901,19919,1517,29119,21233,19211,
21361,3977,16879,22943,28087,12613,13187,7459,9847,6581,
18511,719,2207,19883,18397,11591,18253,18751,3599,17839,
2693,9967,13001,3569,16609,5573,20617,19751,18133,8339,
22277,9829,15397,6403,25951,4799,14327,28279,14513,1151,
19363,11071,16787,1129,7823,22063,12869,16547,13627,16031,
373,14941,10379,27827,7283,2647,10331,7123,16651,21239,
15047,2719,6053,7331,8821,1699,26573,11587,4841,13933,
5011,23747,4159,28643,18757,13561,2699,3197,27019,28793,
14953,20731,10579,11603,2047,13991,25423,25679,25997,28537,
281,13183,8221,89,25957,9491,19933,1531,22289,2447,
8809,29363,28027,14681,15749,9049,4523,21247,9523,22441,
7919,20177,13733,6367,26773,16921,12359,24197,24919,23,
2411,10753,11701,2507,11629,15251,26893,5309,7937,15229,
26437,15401,2053,22501,7247,9173,22387,17471,5311,28277,
7549,6683,10807,7961,12811,16799,11569,3683,10957,6731,
27659,22697,12979,28013,7417,14173,10201,25169,22937,20719,
6191,463,19681,3767,12863,1627,29531,23323,3209,27199,
6067,23053,23761,29699,8297,24293,3067,8441,5653,4439,
26177,28549,1013,20467,11321,8401,4409,7999,2423,24161,
18973,24331,7289,17,2689,7433,9973,17551,29027,8119,
21101,18841,15737,21079,24833,21367,22811,25843,18119,6619,
18877,3431,21793,17747,1613,29527,18101,6913,6571,21869,
24917,17419,18367,28961,23311,7769,9469,323,10537,20023,
9421,28289,15137,28519,8483,19597,7873,11881,13199,13907,
7793,19001,9283,17581,16669,26093,997,19241,3163,21899,
15707,9979,16241,27883,3659,1997,4133,22807,7811,18883,
18541,24077,199,9833,3247,30011,29401,1049,12829,26153,
6311,29473,16771,6239,24109,6997,6613,28319,9497,28489,
19763,28661,3613,15481,16997,12469,21997,29951,18283,16967,
11449,6907,25901,12763,1501,29279,17117,563,7057,19801,
23759,2027,29573,7027,28141,8399,22279,13553,14527,7361,
13723,19291,5399,17027,17933,5773,20701,12569,15889,29213,
11441,10963,11281,20777,2179,11813,29977,26381,23159,1217,
7879,22027,23801,8353,13471,14159,2033,8317,7391,20143,
8849,23027,15949,25373,12161,19111,2729,4219,10117,25001,
28843,15721,4139,4427,3529,13523,8887,13753,10411,22019,
13487,11689,2543,4243,28711,5657,24623,29137,19661,20173,
5099,24527,10399,6277,8681,22921,20249,5147,5393,23923,
5521,16199,2657,17209,20963,8287,29591,7981,3893,25027,
28361,17191,2039,4579,9323,24007,4723,6211,23069,9589,
4013,29501,7603,3557,10999,13493,27877,3911,7573,6359,
20957,17749,15727,12461,12343,26281,18989,17957,14843,11381,
8803,18331,18719,22397,29179,20257,20791,11549,21323,1087,
21641,16873,20551,27869,16607,14029,29063,1327,14383,1801,
13067,8329,443,14591,25243,19051,13217,5329,4463,25777,
5171,1637,2839,16777,27751,9959,27617,26813,16087,6971,
6703,7201,15149,383,21517,1451,1259,11989,17123,29857,
28991,29683,30001,15269,17657,28309,3847,4093,2489,2777,
7489,2963,28871,26293,6451,26027,12679,3203,21577,19753,
22109,28097,13721,11923,24181,28859,25517,28057,21881,16363,
28201,16619,21977,409,1433,16571,6511,27089,13249,15023,
20827,23321,9313,11941,5267,13399,7853,277,11251,28109,
12437,15469,10313,8291,2251,5959,9293,8977,20803,4889,
21377,4729,26227,25691,1633,26701,11639,10397,7477,27971,
29173,26941,19979,4189,10883,7237,23921,7771,22679,27529,
13763,9697,7213,5609,8627,2183,1747,3673,12301,23909,
3407,6439,25433,9341,8443,151,14057,9319,24203,12941,
8413,23789,5627,22159,21817,26951,11293,4021,14177,4553,
10837,26711,3001,29429,25967,19099,25163,20047,26441,19741,
20809,12923,22507,2111,22123,23039,1907,1429,9533,5107,
21751,13619,11387,16099,25873,28921,29177,26959,19793,29347,
24911,11773,14759,6887,17617,2263,19141,27389,5813,12307,
17681,17203,17911,11369,21557,16999,10253,8917,22871,2099,
17239,20903,21851,25903,19711,18839,9257,14239,2813,14557,
7663,6001,10547,5809,27323,18791,28081,13427,28009,16747,
4331,5053,13499,4309,7327,12671,10243,28649,15437,20093,
8737,6551,2293,13501,6437,26659,29917,24341,21001,3149,
27949,11873,8227,17651,20971,16739,3587,23899,6173,26527,
3253,21121,22439,9287,14723,14381,27763,6031,22877,23783,
12547,7691,12403,19589,5359,25481,9403,21031,10589,27407,
13373,11257,19361,16573,12527,9439,28313,28657,27701,24781,
12599,24379,21533,9487,13241,27163,5221,15479,21799,23813,
18163,16769,7187,5389,10181,12853,27031,23927,10159,10447,
9161,6733,4469,14657,22999,16147,14351,8143,8431,28667,
9803,18607,26023,17491,19139,11267,11093,4717,7121,9661,
26879,17659,11243,21457,9103,28531,14639,12407,6679,24863,
24253,9151,24119,2987,26903,29921,20203,6661,27589,23363,
9187,5591,59,26627,26359,10477,5321,6043,11849,20513,
3697,5081,27073,20399,2237,27499,20753,19627,19091,7561,
11969,1909,22691,10363,24961,22619,2117,10459,4267,22993,
21961,17399,20417,9379,27953,22723,26401,3347,13073,8347,
8111,15553,6047,19639,17827,4061,1843,20611,15629,14387,
16943,6341,17071,4649,21137,12589,18653,15217,17221,3169,
10823,22717,23741,5641,13589,27947,7013,5527,13963,1591,
20759,4969,15563,8711,19153,28967,29479,22733,16327,15461,
5263,4049,9407,26989,11107,10151,19273,21661,509,27197,
10223,5587,18311,6493,6781,27959,3917,26869,3533,1,
};


uint32_t div_by_6(uint32_t in)
{
    return in / 6;
}

uint32_t div_by_30(uint32_t in)
{
    return in / 30;
}

uint32_t div_by_210(uint32_t in)
{
    return in / 210;
}

uint32_t div_by_420(uint32_t in)
{
    return in / 420;
}

uint32_t div_by_2310(uint32_t in)
{
    return in / 2310;
}

uint32_t div_by_4620(uint32_t in)
{
    return in / 4620;
}

uint32_t div_by_30030(uint32_t in)
{
    return in / 30030;
}

uint32_t mod_by_6(uint32_t in)
{
    return in % 6;
}

uint32_t mod_by_30(uint32_t in)
{
    return in % 30;
}

uint32_t mod_by_210(uint32_t in)
{
    return in % 210;
}

uint32_t mod_by_420(uint32_t in)
{
    return in % 420;
}

uint32_t mod_by_2310(uint32_t in)
{
    return in % 2310;
}

uint32_t mod_by_4620(uint32_t in)
{
    return in % 4620;
}

uint32_t mod_by_30030(uint32_t in)
{
    return in % 30030;
}

uint32_t(*mod_fcn)(uint32_t);
uint32_t(*div_fcn)(uint32_t);



void compute_roots_work_fcn(void *vptr)
{
    tpool_t *tdata = (tpool_t *)vptr;
    soe_userdata_t *udata = (soe_userdata_t *)tdata->user_data;
    soe_staticdata_t *sdata = udata->sdata;
    thread_soedata_t *t = &udata->ddata[tdata->tindex];
    uint32_t *last_root;
    uint32_t *last_p;
    uint32_t *class_inv;
    int *res_table;
    int i;
    uint32_t pn = sdata->prodN;    
    uint32_t start_res;
    uint32_t pdiff;
    uint32_t last_prime;
    

    if (sdata->VFLAG > 2)
    {
        printf("starting root computation over %u to %u\n", t->startid, t->stopid);
    }

    uint32_t numclasses = sdata->numclasses;
    
    // this function requires the full residue class table.
    // (if we're using twins residues we need to re-find them.)
    res_table = malloc(sdata->prodN * sizeof(int));
    memset(res_table, -1, sizeof(int));
    if (sdata->numclasses == 30)
    {
        uint32_t rclass[48];
        numclasses = 48;
        int k = 0;
        for (i = 1; i < pn; i++)
        {
            if (gcd_1(i, (uint64_t)pn) == 1)
            {
                rclass[k] = (uint32_t)i;
                k++;
            }
        }
        for (i = 0; i < numclasses; i++)
            res_table[rclass[i]] = i;
    }
    else if (sdata->numclasses == 270)
    {
        uint32_t rclass[480];
        numclasses = 480;
        int k = 0;
        for (i = 1; i < pn; i++)
        {
            if (gcd_1(i, (uint64_t)pn) == 1)
            {
                rclass[k] = (uint32_t)i;
                k++;
            }
        }
        for (i = 0; i < numclasses; i++)
            res_table[rclass[i]] = i;
    }
    else
    {
        for (i = 0; i < numclasses; i++)
            res_table[sdata->rclass[i]] = i;
    }   

    last_root = (uint32_t *)calloc(numclasses, sizeof(uint32_t));
    last_p = (uint32_t *)calloc(numclasses, sizeof(uint32_t));

    class_inv = class_inv6;
    if (t->sdata.prodN == 6)
    {
        div_fcn = &div_by_6;
        mod_fcn = &mod_by_6;
        class_inv = class_inv6;
    }
    else if (t->sdata.prodN == 30)
    {
        div_fcn = &div_by_30;
        mod_fcn = &mod_by_30;
        class_inv = class_inv30;
    }
    else if (t->sdata.prodN == 210)
    {
        div_fcn = &div_by_210;
        mod_fcn = &mod_by_210;
        class_inv = class_inv210;
    }
    else if (t->sdata.prodN == 420)
    {
        div_fcn = &div_by_420;
        mod_fcn = &mod_by_420;
        class_inv = class_inv420;
    }
    else if (t->sdata.prodN == 2310)
    {
        div_fcn = &div_by_2310;
        mod_fcn = &mod_by_2310;
        class_inv = class_inv2310;
    }
    else if (t->sdata.prodN == 4620)
    {
        div_fcn = &div_by_4620;
        mod_fcn = &mod_by_4620;
        class_inv = class_inv4620;
    }
    else if (t->sdata.prodN == 30030)
    {
        div_fcn = &div_by_30030;
        mod_fcn = &mod_by_30030;
        class_inv = class_inv30030;
    }
    else
    {
        if (t->sdata.sieve_range == 0)
        {
            printf("invalid num_classes\n");
            exit(1);
        }
    }

    start_res = sdata->sieve_p[t->startid] % pn;
    last_prime = sdata->sieve_p[t->startid];

    if (t->sdata.sieve_range == 0)
    {

#if defined(USE_AVX2) || defined(_WIN64)
        //int j = 0;

        if (t->sdata.use_monty)
        {            
            for (i = t->startid;  i < t->stopid; i++)
            {
                uint32_t inv;
                uint32_t prime = t->sdata.sieve_p[i];
                uint32_t x;
#ifdef USE_NEW_ROOTCALC
                uint32_t classnum;

                pdiff = prime - last_prime;
                // mul-by-inverse division.
                classnum = mod_fcn(start_res + pdiff);
                start_res = classnum;
                classnum = res_table[classnum];

                last_prime = prime;

                if (last_root[classnum] == 0)
                {
                    // start the process with the first prime in this class
                    inv = modinv3(pn, prime);
                    t->sdata.root[i] = prime - inv;
                    last_root[classnum] = inv;
                    last_p[classnum] = prime;

                    //if ((i - t->startid) < 100)
                    //    printf("first prime for class %d = %u, inv = %u, root = %u\n",
                    //    start_res, prime, inv, t->sdata.root[i]);
                }
                else
                {
                    // compute the root using the last prime in this class,
                    // no inversion necessary
                    inv = last_root[classnum];
                    x = div_fcn(prime - last_p[classnum]);
                    last_root[classnum] = inv + x * class_inv[classnum];
                    t->sdata.root[i] = prime - last_root[classnum];

                    //if ((i - t->startid) < 100)
                    //    printf("last root,prime for class %d = %u,%u, this prime = %u, "
                    //    "class inv = %u, this root = %u\n",
                    //    start_res, inv, last_p[classnum], prime, 
                    //    class_inv[classnum], t->sdata.root[i]);

                    last_p[classnum] = prime;                   
                }

#else
                // slightly optimized modinv when prime >> prodN
                inv = modinv3(t->sdata.prodN, prime);
                t->sdata.root[i] = prime - inv;
#endif

                // implement a special case for lowlimit = 0?
                t->sdata.lower_mod_prime[i] =
                    (t->sdata.lowlimit + 1) % prime;

                //if ((i - t->startid) < 100)
                //    printf("lower_mod_p = %u\n", t->sdata.lower_mod_prime[i]);

                x = (((prime + 2) & 4) << 1) + prime; // here x*a==1 mod 2**4
                x *= 2 - prime * x;               // here x*a==1 mod 2**8
                x *= 2 - prime * x;               // here x*a==1 mod 2**16
                x *= 2 - prime * x;               // here x*a==1 mod 2**32
                // rho = -1/m mod b
                t->sdata.pinv[i] = (uint32_t)0 - (uint32_t)x;
                t->sdata.r2modp[i] = (uint32_t)(0x100000000ULL % (uint64_t)prime);
                t->sdata.r2modp[i] =
                    ((uint64_t)t->sdata.r2modp[i] * (uint64_t)t->sdata.r2modp[i]) % (uint64_t)prime;

                // root into monty
                t->sdata.root[i] = to_monty_loc(t->sdata.root[i], t->sdata.r2modp[i],
                    t->sdata.pinv[i], prime);
            }            
            
        }
        else
        {
            for (i = t->startid;  i < t->stopid; i++)
            {
                uint32_t inv;
                uint32_t prime = t->sdata.sieve_p[i];
#ifdef USE_NEW_ROOTCALC
                uint32_t x;
                uint32_t classnum;

                // when we are not using Monty, numclasses = 6;  It helps
                // a lot to hardcode the divisor as the compiler will
                // replace with multiplication by a constant inverse.
                pdiff = prime - last_prime;
                classnum = mod_fcn(start_res + pdiff);
                start_res = classnum;
                classnum = res_table[classnum];

                last_prime = prime;

                if (last_root[classnum] == 0)
                {
                    // start the process with the first prime in this class
                    inv = modinv3(pn, prime);
                    t->sdata.root[i] = prime - inv;
                    last_root[classnum] = inv;
                    last_p[classnum] = prime;
                }
                else
                {
                    // compute the root using the last prime in this class
                    inv = last_root[classnum];
                    x = div_fcn(prime - last_p[classnum]);
                    last_root[classnum] = inv + x * class_inv[classnum];
                    t->sdata.root[i] = prime - last_root[classnum];
                    last_p[classnum] = prime;
                }

#else
                // slightly optimized modinv when prime >> prodN
                inv = modinv3(t->sdata.prodN, prime);
                t->sdata.root[i] = prime - inv;
#endif

                t->sdata.lower_mod_prime[i] =
                    (t->sdata.lowlimit + 1) % prime;
            }
        }

#else

        // in this new approach, we no longer need to compute modinv(pn, prime)
        // for every prime.  Instead, we only compute it for the first prime
        // in each residue class; subsequent primes can compute their root
        // using the result from the previous prime in the same class along
        // with a few precomputed constants and a small division (likely 
        // accelerated by compiler multiply-by-inverse tricks).
        for (i = t->startid; i < t->stopid; i++)
        {
            uint32_t inv;            
            uint32_t prime = t->sdata.sieve_p[i];
#ifdef USE_NEW_ROOTCALC
            uint32_t x;
            uint32_t classnum;

            // It helps to hardcode the divisor as the compiler will
            // replace with multiplication by a constant inverse.
            pdiff = prime - last_prime;
            classnum = mod_fcn(start_res + pdiff);
            start_res = classnum;
            classnum = res_table[classnum];

            last_prime = prime;

            if (last_root[classnum] == 0)
            {
                // start the process with the first prime in this class
                // by using modinv.
                inv = modinv3(pn, prime);
                t->sdata.root[i] = prime - inv;
                last_root[classnum] = inv;
                last_p[classnum] = prime;
            }
            else
            {
                // compute the root using the last prime in this class.
                // if the root of the previous prime in this class is R,
                // and the difference between this prime and last is dP, 
                // then the root for this prime is P - (R + dP / PW * cn^-1),
                // where PW is the product of wheel primes and cn^-1 is the
                // inverse of this classnum mod PW.
                inv = last_root[classnum];
                x = div_fcn(prime - last_p[classnum]);
                last_root[classnum] = inv + x * class_inv[classnum];
                t->sdata.root[i] = prime - last_root[classnum];
                last_p[classnum] = prime;
            }
#else

            // slightly optimized modinv when prime >> prodN
            inv = modinv3(t->sdata.prodN, prime);
            t->sdata.root[i] = prime - inv;
#endif

            t->sdata.lower_mod_prime[i] =
                (t->sdata.lowlimit + 1) % prime;
        }

#endif
    }
    else
    {
        mpz_t tmpz;
        mpz_init(tmpz);

        mpz_add_ui(tmpz, t->sdata.offset, t->sdata.lowlimit + 1);
        for (i = t->startid; i < t->stopid; i++)
        {
            uint32_t inv;
            uint32_t prime = t->sdata.sieve_p[i];

            // slightly optimized modinv when prime >> prodN
            inv = modinv3(t->sdata.prodN, prime);
            t->sdata.root[i] = prime - inv;

            t->sdata.lower_mod_prime[i] =
                mpz_tdiv_ui(tmpz, prime);
        }
        mpz_clear(tmpz);
    }

    free(last_root);
    free(last_p );
    free(res_table);

    return;
}


void getRoots(soe_staticdata_t *sdata, thread_soedata_t *thread_data)
{
    int prime, prodN;
    uint64_t startprime;
    uint64_t lblk_b, ublk_b, blk_b_sqrt;
    uint64_t i;
    int j;
    uint32_t range, lastid;

    // timing
    double t;
    struct timeval tstart, tstop;

    // threading structures
    tpool_t *tpool_data;
    soe_userdata_t udata;

    prodN = (int)sdata->prodN;
    startprime = sdata->startprime;
    
    if (sdata->VFLAG > 1)
    {
        gettimeofday(&tstart, NULL);
    }
    
    lblk_b = sdata->lowlimit;
    ublk_b = sdata->blk_r + lblk_b - sdata->prodN;
    blk_b_sqrt = (uint32_t)(sqrt(ublk_b + sdata->prodN)) + 1;
    
    for (i = startprime; i < sdata->bucket_start_id; i++)
    {
        uint32_t inv;
        prime = sdata->sieve_p[i];

        // sieving requires that we find the offset of each sieve prime in each block 
        // that we sieve.  We are more restricted in choice of offset because we
        // sieve residue classes.  A good way to find the offset is the extended 
        // euclidean algorithm, which reads ax + by = gcd(a,b),
        // where a = prime, b = prodN, and therefore gcd = 1.  
        // since a and b are coprime, y is the multiplicative inverse of prodN modulo prime.
        // This value is a constant, so compute it here in order to facilitate 
        // finding offsets later.

        // if (sdata->sieve_p[i] > blk_b_sqrt)
        // {
        //     lblk_b = ublk_b + prodN;
        //     ublk_b += sdata->blk_r;
        //     blk_b_sqrt = (uint64_t)(sqrt((int64_t)(ublk_b + prodN))) + 1;
        // }

        //solve prodN ^ -1 % p 
        inv = modinv1(prodN, prime);
        sdata->root[i] = prime - inv;
    }

    if (sdata->VFLAG > 1)
    {
        gettimeofday(&tstop, NULL);
        t = ytools_difftime(&tstart, &tstop);

        if (sdata->VFLAG > 2)
        {
            printf("time to compute linear sieve roots = %1.6f\n", t);
        }

        gettimeofday(&tstart, NULL);
    }

    range = (sdata->bitmap_start_id - sdata->bucket_start_id) / sdata->THREADS;
    //range = (sdata->pboundi - sdata->bucket_start_id) / sdata->THREADS;
    lastid = sdata->bucket_start_id;

    if (range > 0)
    {
        // divvy up the primes left to compute
        for (j = 0; j < sdata->THREADS; j++)
        {
            thread_soedata_t *t = thread_data + j;

            t->sdata = *sdata;
            t->startid = lastid;
            t->stopid = t->startid + range;
            lastid = t->stopid;

            if (sdata->VFLAG > 2)
            {
                printf("bucket start id = %u, bitmap start id = %u\n",
                    sdata->bucket_start_id, sdata->bitmap_start_id);
                printf("assigning thread %d root computation over %u to %u\n",
                    j, t->startid, t->stopid); fflush(stdout);
            }
        }

        // the last one gets any leftover
        if (thread_data[sdata->THREADS - 1].stopid != sdata->bitmap_start_id)
        {
            thread_data[sdata->THREADS - 1].stopid = sdata->bitmap_start_id;
            //thread_data[sdata->THREADS - 1].stopid = sdata->pboundi;
        }

        udata.sdata = sdata;
        udata.ddata = thread_data;
        tpool_data = tpool_setup(sdata->THREADS, NULL, NULL, NULL,
            &compute_roots_dispatch, &udata);

        if (sdata->THREADS == 1)
        {
            compute_roots_work_fcn(tpool_data);
        }
        else
        {
            sdata->sync_count = 0;
            tpool_add_work_fcn(tpool_data, &compute_roots_work_fcn);
            tpool_go(tpool_data);
        }
        free(tpool_data);
    }

    if (sdata->VFLAG > 1)
    {
        gettimeofday(&tstop, NULL);

        t = ytools_difftime(&tstart, &tstop);

        if (sdata->VFLAG > 2)
        {
            printf("time to compute bucket sieve roots = %1.6f\n", t);
        }
    }

	return;
}


